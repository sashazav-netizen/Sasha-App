<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>× ×™×”×•×œ ×ª×§×¦×™×‘ | ××œ×›×¡× ×“×¨ ×–×‘×•×“×™×¡×§×¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8fafc; margin: 0; padding: 0; }
        .selected-cat { border: 3px solid #4f46e5 !important; background-color: #eef2ff !important; }
        * { -webkit-tap-highlight-color: transparent; user-select: none; }
        input { user-select: auto !important; -webkit-user-select: auto !important; font-size: 16px !important; }
        #chartContainer { width: 100%; max-width: 160px; margin: 0 auto 15px auto; min-height: 160px; position: relative; }
        .tab-active { color: #4f46e5; border-bottom: 2px solid #4f46e5; }
        
        /* ××™×¤×•×™ ×¦×‘×¢×™× ×œ×§×˜×’×•×¨×™×•×ª */
        .color-××•×›×œ { color: #f97316; background-color: #fff7ed; }
        .color-×§× ×™×•×ª { color: #ec4899; background-color: #fdf2f8; }
        .color-×¨×›×‘ { color: #3b82f6; background-color: #eff6ff; }
        .color-×‘×™×ª { color: #6366f1; background-color: #eef2ff; }
        .color-×¤× ××™ { color: #eab308; background-color: #fefce8; }
        .color-××—×¨ { color: #94a3b8; background-color: #f8fafc; }
    </style>
</head>
<body class="font-sans pb-32 text-right text-slate-800">

    <div class="bg-white p-6 shadow-sm mb-4 sticky top-0 z-10 border-b border-slate-100">
        <div class="flex justify-start gap-2 mb-2 absolute top-6 right-6">
            <button onclick="exportToCSV()" class="w-9 h-9 flex items-center justify-center bg-slate-50 text-indigo-600 rounded-xl border border-slate-100"><i class="fas fa-file-download"></i></button>
            <button onclick="clearAllData()" class="w-9 h-9 flex items-center justify-center bg-slate-50 text-slate-300 rounded-xl border border-slate-100"><i class="fas fa-trash-alt text-xs"></i></button>
        </div>

        <div class="text-center mb-4 pt-2">
            <div class="inline-flex items-center justify-center w-12 h-12 bg-indigo-50 rounded-full border-4 border-white shadow-inner mb-1">
                <span class="text-2xl">ğŸ’°</span>
            </div>
            <h1 class="text-lg font-black text-slate-900 tracking-tighter">× ×™×”×•×œ ×ª×§×¦×™×‘ ×—×›×</h1>
        </div>
        
        <div class="flex gap-4 mb-4">
            <div class="flex-1 bg-emerald-50 p-2 rounded-2xl text-center border border-emerald-100">
                <span class="block text-[9px] font-bold text-emerald-600 mb-0.5 uppercase">×”×›× ×¡×•×ª</span>
                <span id="incText" class="font-bold text-base text-emerald-700">â‚ª 0</span>
            </div>
            <div class="flex-1 bg-rose-50 p-2 rounded-2xl text-center border border-rose-100">
                <span class="block text-[9px] font-bold text-rose-600 mb-0.5 uppercase">×”×•×¦××•×ª</span>
                <span id="expText" class="font-bold text-base text-rose-700">â‚ª 0</span>
            </div>
        </div>

        <div class="flex justify-center gap-6 mb-3 border-b border-slate-50 text-[10px] font-bold text-slate-400">
            <button id="tabExp" onclick="changeChartTab('expense')" class="pb-1 tab-active">×”×•×¦××•×ª %</button>
            <button id="tabInc" onclick="changeChartTab('income')" class="pb-1">×”×›× ×¡×•×ª %</button>
        </div>

        <div id="chartContainer">
            <canvas id="mainChart"></canvas>
        </div>
    </div>

    <div id="list" class="p-4 space-y-2"></div>

    <div class="fixed bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-slate-50 via-slate-50 z-40">
        <button onclick="openModal()" class="w-full max-w-sm mx-auto block bg-indigo-600 text-white py-3.5 rounded-full font-bold shadow-2xl active:scale-95 transition-all text-lg">+ ×”×•×¡×¤×ª ×ª× ×•×¢×”</button>
        <p class="text-center text-[10px] text-slate-400 font-medium mt-2">××œ×›×¡× ×“×¨ ×–×‘×•×“×™×¡×§×¨ 2026</p>
    </div>

    <div id="formModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden items-center justify-center p-4 z-[100]">
        <div class="bg-white w-full max-w-sm rounded-[2.5rem] p-6 shadow-2xl overflow-y-auto max-h-[90vh]">
            <div class="flex bg-slate-100 p-1 rounded-xl mb-4">
                <button id="typeExp" onclick="setMode('expense')" class="flex-1 py-2.5 rounded-xl bg-white text-red-600 font-bold shadow">×”×•×¦××”</button>
                <button id="typeInc" onclick="setMode('income')" class="flex-1 py-2.5 rounded-xl text-slate-500 font-bold">×”×›× ×¡×”</button>
            </div>
            <input type="number" id="amt" inputmode="decimal" placeholder="×¡×›×•× â‚ª" class="w-full text-4xl font-bold p-3 bg-slate-50 rounded-2xl mb-4 text-center outline-none border-2 border-transparent focus:border-indigo-500 text-slate-800">
            <input type="text" id="desc" placeholder="×ª×™××•×¨..." class="w-full p-4 bg-slate-50 rounded-2xl mb-4 text-center outline-none border-2 border-transparent focus:border-indigo-500 font-medium text-right" dir="rtl">
            <div class="grid grid-cols-3 gap-2 mb-6 text-right">
                <button onclick="setCat(event, '××•×›×œ', 'fa-utensils')" class="cat-btn p-3 bg-slate-50 rounded-xl flex flex-col items-center border-2 border-transparent"><i class="fas fa-utensils text-orange-500"></i><span class="text-[10px] mt-1 font-bold">××•×›×œ</span></button>
                <button onclick="setCat(event, '×§× ×™×•×ª', 'fa-shopping-bag')" class="cat-btn p-3 bg-slate-50 rounded-xl flex flex-col items-center border-2 border-transparent"><i class="fas fa-shopping-bag text-pink-500"></i><span class="text-[10px] mt-1 font-bold">×§× ×™×•×ª</span></button>
                <button onclick="setCat(event, '×¨×›×‘', 'fa-car')" class="cat-btn p-3 bg-slate-50 rounded-xl flex flex-col items-center border-2 border-transparent"><i class="fas fa-car text-blue-500"></i><span class="text-[10px] mt-1 font-bold">×¨×›×‘</span></button>
                <button onclick="setCat(event, '×‘×™×ª', 'fa-home')" class="cat-btn p-3 bg-slate-50 rounded-xl flex flex-col items-center border-2 border-transparent"><i class="fas fa-home text-indigo-500"></i><span class="text-[10px] mt-1 font-bold">×‘×™×ª</span></button>
                <button onclick="setCat(event, '×¤× ××™', 'fa-grin-stars')" class="cat-btn p-3 bg-slate-50 rounded-xl flex flex-col items-center border-2 border-transparent"><i class="fas fa-grin-stars text-yellow-500"></i><span class="text-[10px] mt-1 font-bold">×¤× ××™</span></button>
                <button onclick="setCat(event, '××—×¨', 'fa-ellipsis-h')" class="cat-btn p-3 bg-slate-50 rounded-xl flex flex-col items-center border-2 border-transparent selected-cat"><i class="fas fa-ellipsis-h text-slate-500"></i><span class="text-[10px] mt-1 font-bold">××—×¨</span></button>
            </div>
            <div class="flex gap-2">
                <button onclick="save()" class="flex-[2] bg-indigo-600 text-white py-4 rounded-2xl font-bold shadow-lg">×©××•×¨</button>
                <button onclick="closeModal()" class="flex-1 bg-slate-100 text-slate-500 py-4 rounded-2xl font-bold">×‘×™×˜×•×œ</button>
            </div>
        </div>
    </div>

    <script>
        Chart.register(ChartDataLabels);
        let data = JSON.parse(localStorage.getItem('cash_v_final')) || [];
        let mode = 'expense', selectedCat = '××—×¨', selectedIcon = 'fa-ellipsis-h', chartMode = 'expense', chartInstance = null;

        const catColors = { '××•×›×œ': '#f97316', '×§× ×™×•×ª': '#ec4899', '×¨×›×‘': '#3b82f6', '×‘×™×ª': '#6366f1', '×¤× ××™': '#eab308', '××—×¨': '#94a3b8' };

        function openModal() { document.getElementById('formModal').style.display = 'flex'; }
        function closeModal() { document.getElementById('formModal').style.display = 'none'; }

        function setMode(m) {
            mode = m;
            document.getElementById('typeExp').className = m === 'expense' ? 'flex-1 py-2.5 rounded-xl bg-white text-red-600 font-bold shadow' : 'flex-1 py-2.5 rounded-xl text-slate-500 font-bold';
            document.getElementById('typeInc').className = m === 'income' ? 'flex-1 py-2.5 rounded-xl bg-white text-green-600 font-bold shadow' : 'flex-1 py-2.5 rounded-xl text-slate-500 font-bold';
        }

        function setCat(e, n, i) {
            selectedCat = n; selectedIcon = i;
            document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('selected-cat'));
            e.currentTarget.classList.add('selected-cat');
        }

        function changeChartTab(m) {
            chartMode = m;
            document.getElementById('tabExp').classList.toggle('tab-active', m === 'expense');
            document.getElementById('tabInc').classList.toggle('tab-active', m === 'income');
            updateChart();
        }

        function updateChart() {
            const filteredData = data.filter(i => i.mode === chartMode);
            const categories = {};
            let total = 0;
            filteredData.forEach(i => { categories[i.cat] = (categories[i.cat] || 0) + i.val; total += i.val; });

            const ctx = document.getElementById('mainChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();
            const labels = Object.keys(categories);
            if (labels.length === 0) return;

            const colors = chartMode === 'expense' ? labels.map(l => catColors[l]) : ['#10b981', '#059669', '#34d399', '#064e3b', '#6ee7b7'];

            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: Object.values(categories),
                        backgroundColor: colors,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, cutout: '60%',
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            color: '#000', // ×©×™× ×™×ª×™ ×œ×©×—×•×¨ ×‘×•×œ×˜
                            font: { weight: '900', size: 10 },
                            backgroundColor: 'rgba(255,255,255,0.7)', // ×¨×§×¢ ×œ×‘×Ÿ ×©×§×•×£ ×œ××—×•×–×™×
                            borderRadius: 4,
                            padding: 2,
                            formatter: (val) => { let p = (val/total*100).toFixed(0)+'%'; return p === '0%' ? '' : p; }
                        }
                    }
                }
            });
        }

        function save() {
            const val = parseFloat(document.getElementById('amt').value);
            if(!val) return;
            data.push({ id: Date.now(), val, desc: document.getElementById('desc').value.trim() || selectedCat, cat: selectedCat, icon: selectedIcon, mode, date: new Date().toLocaleDateString('he-IL', {day:'2-digit', month:'2-digit'}) });
            localStorage.setItem('cash_v_final', JSON.stringify(data));
            document.getElementById('amt').value = ''; document.getElementById('desc').value = '';
            closeModal(); render();
        }

        function del(id) { if(confirm("×œ××—×•×§?")) { data = data.filter(i => i.id !== id); localStorage.setItem('cash_v_final', JSON.stringify(data)); render(); } }

        function render() {
            const list = document.getElementById('list'); list.innerHTML = '';
            let ti = 0, te = 0;
            [...data].reverse().forEach(i => {
                if(i.mode === 'income') ti += i.val; else te += i.val;
                const catClass = `color-${i.cat}`;
                const accentColor = i.mode === 'income' ? '#10b981' : (catColors[i.cat] || '#94a3b8');

                list.innerHTML += `<div class="bg-white p-3.5 rounded-2xl flex justify-between items-center shadow-sm mb-2 border-r-4" style="border-right-color: ${accentColor}">
                    <div class="flex items-center gap-3">
                        <div class="w-9 h-9 rounded-full flex items-center justify-center text-sm ${catClass}"><i class="fas ${i.icon}"></i></div>
                        <div><p class="font-bold text-slate-800 text-xs leading-tight">${i.desc}</p><p class="text-[9px] text-slate-400 font-bold">${i.date} â€¢ <button onclick="del(${i.id})">××—×§</button></p></div>
                    </div>
                    <p class="font-black text-sm ${i.mode === 'income' ? 'text-emerald-500' : 'text-rose-500'}">â‚ª${i.val.toLocaleString()}</p>
                </div>`;
            });
            document.getElementById('incText').innerText = 'â‚ª' + ti.toLocaleString();
            document.getElementById('expText').innerText = 'â‚ª' + te.toLocaleString();
            updateChart();
        }

        function exportToCSV() {
            let csv = "\uFEFF×ª××¨×™×š,×ª×™××•×¨,×§×˜×’×•×¨×™×”,×¡×•×’,×¡×›×•×\n";
            data.forEach(i => csv += `${i.date},${i.desc},${i.cat},${i.mode === 'income' ? '×”×›× ×¡×”' : '×”×•×¦××”'},${i.val}\n`);
            const link = document.createElement("a");
            link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' }));
            link.download = `×ª×§×¦×™×‘.csv`; link.click();
        }
        function clearAllData() { if(confirm("×œ××—×•×§ ×”×›×œ?")) { data = []; localStorage.removeItem('cash_v_final'); render(); } }
        render();
    </script>
</body>
</html>
